<div *ngIf="loading" class="spinner-container">
  <div class="d-flex justify-content-center">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
</div>
<div *ngIf="error && !loading" class="alert alert-danger" role="alert">
  {{ error }}
</div>
<div *ngIf="unit && !loading && !error" class="unit-details-container">
  <h2>{{ unit.title }}</h2>
  <p><strong>Owner:</strong> {{ unit.ownerName }}</p>
  <p><strong>Description:</strong> {{ unit.description }}</p>
  <p><strong>Type:</strong> {{ unit.unitType }}</p>
  <p><strong>Bedrooms:</strong> {{ unit.bedrooms }}</p>
  <p><strong>Bathrooms:</strong> {{ unit.bathrooms }}</p>
  <p><strong>Sleeps:</strong> {{ unit.sleeps }}</p>
  <p><strong>Distance to Sea:</strong> {{ unit.distanceToSea }} m</p>
  <p>
    <strong>Base Price Per Night:</strong> {{ unit.basePricePerNight | currency
    }}
  </p>
  <p><strong>Address:</strong> {{ unit.address }}</p>
  <p><strong>Village:</strong> {{ unit.villageName }}</p>
  <p><strong>Created:</strong> {{ unit.creationDate | date:'mediumDate' }}</p>
  <div class="rating">
    <strong>Average Rating:</strong>
    <ng-container *ngIf="unit.averageUnitRating !== null">
      <span *ngFor="let star of [1,2,3,4,5]">
        <span
          >{{ star <= (unit.averageUnitRating || 0) ? '&#9733;' : '&#9734;'
          }}</span
        >
      </span>
      ({{ unit.averageUnitRating }})
    </ng-container>
    <ng-container *ngIf="unit.averageUnitRating === null"
      >No ratings</ng-container
    >
  </div>

  <!-- Booking Button -->
  <div class="booking-section mt-4">
    <button
      type="button"
      class="btn btn-primary btn-lg"
      (click)="openBookingForm()"
    >
      Book This Unit
    </button>
  </div>

  <!-- Availability Calendar -->
  <div class="calendar-section mt-4">
    <h4>Availability Calendar</h4>
    <div *ngIf="calendarLoading" class="text-center">
      <div class="spinner-border spinner-border-sm" role="status">
        <span class="visually-hidden">Loading calendar...</span>
      </div>
    </div>

    <div *ngIf="!calendarLoading" class="calendar-container">
      <!-- Calendar Header -->
      <div
        class="calendar-header d-flex justify-content-between align-items-center mb-3"
      >
        <button
          class="btn btn-outline-secondary btn-sm"
          (click)="previousMonth()"
        >
          <i class="bi bi-chevron-left"></i> Previous
        </button>
        <h5 class="mb-0">{{ getMonthYearString() }}</h5>
        <button class="btn btn-outline-secondary btn-sm" (click)="nextMonth()">
          Next <i class="bi bi-chevron-right"></i>
        </button>
      </div>

      <!-- Calendar Grid -->
      <div class="calendar-grid">
        <!-- Day Headers -->
        <div class="calendar-day-header">Sun</div>
        <div class="calendar-day-header">Mon</div>
        <div class="calendar-day-header">Tue</div>
        <div class="calendar-day-header">Wed</div>
        <div class="calendar-day-header">Thu</div>
        <div class="calendar-day-header">Fri</div>
        <div class="calendar-day-header">Sat</div>

        <!-- Calendar Days -->
        <div
          *ngFor="let day of calendarDays"
          class="calendar-day"
          [ngClass]="{
            'other-month': !day.isCurrentMonth,
            'today': day.isToday,
            'past': day.isPast,
            'booked': day.isBooked,
            'available': day.isAvailable
          }"
          [title]="day.isToday ? 'Today' + (day.isBooked ? ' (Booked)' : '') : 
                   day.isBooked ? 'Booked' : 
                   day.isAvailable ? 'Available' : 
                   day.isPast ? 'Past' : 'Not Available'"
        >
          {{ day.day }}
          <small
            *ngIf="day.isToday"
            style="
              position: absolute;
              top: -5px;
              right: -5px;
              background: #007bff;
              color: white;
              border-radius: 50%;
              width: 12px;
              height: 12px;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 8px;
            "
            >T</small
          >
        </div>
      </div>

      <!-- Calendar Legend -->
      <div class="calendar-legend mt-3">
        <div class="legend-item">
          <span class="legend-color available"></span>
          <small>Available</small>
        </div>
        <div class="legend-item">
          <span class="legend-color booked"></span>
          <small>Booked</small>
        </div>
        <div class="legend-item">
          <span class="legend-color past"></span>
          <small>Past</small>
        </div>
        <div class="legend-item">
          <span class="legend-color today"></span>
          <small>Today</small>
        </div>
      </div>
    </div>
  </div>

  <div
    *ngIf="unit.unitImages && unit.unitImages.length"
    class="image-gallery mt-3"
  >
    <h4>Images</h4>
    <div class="row">
      @for (item of unit.unitImages; track $index) {
      <div class="col-md-4 mb-3">
        <img
          [src]="item"
          class="img-fluid rounded"
          alt="Unit Image {{ $index + 1 }}"
        />
      </div>
      }
    </div>
  </div>
</div>

<!-- Booking Form Modal -->
<app-booking-form
  [unitId]="unitId || 0"
  [isVisible]="showBookingForm"
  (closeForm)="closeBookingForm()"
  (bookingSuccess)="onBookingSuccess($event)"
></app-booking-form>
